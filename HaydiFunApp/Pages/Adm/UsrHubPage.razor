@page "/adm/usrhub"

@inject NavigationManager NavigationManager
@inject IPubs pubs
@inject UsrHub UsrHub
@implements IDisposable

<style>
    .ug {
        display: grid;
        grid-gap: 4px;
        grid-template-columns: 100px 50px 200px;
        background-color: burlywood;
        /*color: #444;*/
        justify-content: center;
        align-content: center;
        /*height: 100px;*/
        /*overflow: auto;*/
    }

    .tal {
        text-align: left;
    }

    .tac {
        text-align: center;
    }

    .tar {
        text-align: right;
    }

    table, th, td {
        border: 1px solid burlywood;
        border-collapse: collapse;
        padding: 0 4px;
    }
</style>

@*<div class="ug">
    <div>Usr</div>
    <div>Cnt</div>
    <div>InsTS</div>
    @foreach (var kv in UsrHub.Usrs)
    {
        <div>@kv.Value.UsrNN</div>
        <div>@kv.Value.Cnt</div>
        <div>@kv.Value.EXD</div>
    }

</div>*@

<label>
    <label for="isOnline">Online olanlar</label>
    <input type="checkbox" @bind="isOnline" name="isOnline" />
    Normal Blazor binding:
    <input @bind="SrchValue" />
</label>
<button @onclick="Srch">Search</button>

@if (USP.UsrId != 0)
{
    <div style="margin:auto; width: fit-content;">
        <table>
            <caption style="background-color: burlywood;">Üyeler</caption>
            <colgroup>
                <col>
                <col>
                <col>
                <col style="width:50px">
                <col>
                <col>
            </colgroup>
            <thead>
                <tr>
                    <th class="tal">Usr</th>
                    <th>Cnt</th>
                    <th>EXD</th>
                    <th>Avatar</th>
                    <th>Takipcim</th>
                    <th>İzliyorum</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int NOU = 0;
                    int NOC = 0;
                    char Online = '✅'; // (char)0x2705;
                    string aa = "📞☎✅";
                }
                @foreach (var itm in UsrL)
                //@foreach (var kv in UsrHub.UsrD)
                {
                    //var kv = UsrHub.UsrD[itm.Key];
                    var meId = USP.UsrId;
                    var me = UsrHub.UsrD[meId];
                    //var usrId = kv.Key;
                    var usrId = itm;
                    // var usr = kv.Value;
                    var usr = UsrHub.UsrD[itm];

                    char Takipcim = ' ';
                    char Izliyorum = ' ';
                    if (usrId == meId)
                    {
                        Takipcim = '★';
                        Izliyorum = '★';
                    }
                    if (usr.FanD.TryGetValue(meId, out char tv))
                    {
                        Takipcim = tv switch
                        {
                            'T' => '✓',
                            'E' => '⛔', //(char)0x26D4, '✘'(char)0x2718,
                        };
                    }
                    if (me.FanD.TryGetValue(usrId, out char fv))
                    {
                        Izliyorum = fv switch
                        {
                            'T' => '✓',
                            'E' => '⛔'
                        };
                    }
                    Online = ' ';
                    if (usr.isOnline)
                        Online = (char)0x2705;

                    <tr>
                        <td><b>@usr.Usr @Online</b></td>
                        <td class="tac">@usr.Cnt.ToString("#")</td>
                        <td>@usr.EXD</td>
                        <td class="px-0"><img src="@usr.ImgUrl" style="display:block" /></td>
                        <td class="tac" style="font-weight:bold">@Takipcim</td>
                        <td class="tac" style="font-weight:bold">@Izliyorum</td>
                    </tr>
                    <tr style="background-color: beige">
                        <td colspan="9">@usr.LblAds</td>
                    </tr>
                    NOU++;
                    NOC += usr.Cnt;
                }
            </tbody>
            <tfoot style="background-color: burlywood;">
                <tr>
                    <td class="tac">@NOU</td>
                    <td class="tac">@NOC</td>
                    <td colspan="9"></td>
                </tr>
            </tfoot>
        </table>
    </div>
}


@code {
    [CascadingParameter] private UserStateProvider? USP { get; set; }
    string SrchValue = "1,9";
    bool isOnline;
    Dictionary<int, string[]> Usrs = new();

    List<int> UsrL = new List<int>();

    public void Srch()
    {
        HashSet<int> shs = new();
        Constants.StringToHashSet(SrchValue, shs);

        UsrL.Clear();
        foreach (var itm in UsrHub.UsrD.Values)
        {
            if(!isOnline || itm.isOnline)
                if (shs.Count == 0 || shs.IsProperSubsetOf(itm.LblH))
                    UsrL.Add(itm.UTid);
        }
    }

    public void Srch2()
    {
        //Usrs = UsrHub.UsrD.Values.Contains(x=> x.Lbls.Contains("6,")). 
        Usrs.Clear();
        foreach (var itm in UsrHub.UsrD.Values)
        {
            // if online Lbls += ",O";
            var oll = itm.Cnt > 0 ? ",O" : "";
            var lbls = itm.Lbls + oll;
            Usrs.Add(itm.UTid, lbls.Split(',', StringSplitOptions.RemoveEmptyEntries));
        }
        foreach (var s in SrchValue.Split(',', StringSplitOptions.RemoveEmptyEntries))
        {
            foreach (var i in Usrs)
            {
                if (!i.Value.Contains(s))
                    Usrs.Remove(i.Key);
            }
        }

        //UsrIds = UsrHub.UsrD.Values.Where(x => x.Lbls.Contains(SrchValue)).Select(x=> x.UTid).ToList();
    }

    public override async Task SetParametersAsync(ParameterView parameters)
    {
        //if (parameters.TryGetValue<UserStateProvider>(nameof(USP), out var value))
        //{
        //  if (value is null || value.UsrTyp != "A")
        //    NavigationManager.NavigateTo("");
        //  else
        //    await base.SetParametersAsync(parameters);  //Diger LifeCyle metodlarini cagiriyor
        //}
        await base.SetParametersAsync(parameters);  //Diger LifeCyle metodlarini cagiriyor
    }
    protected override void OnParametersSet()
    {
        UsrL.Clear();
        foreach (var itm in UsrHub.UsrD.Values)
        {
            UsrL.Add(itm.UTid);
        }

        Usrs.Clear();
        foreach (var itm in UsrHub.UsrD.Values)
        {
            Usrs.Add(itm.UTid, itm.Lbls.Split(',', StringSplitOptions.RemoveEmptyEntries));

        }
    }

    protected override void OnInitialized()
    {
        //pubs.UsrChanged += OnUsrChanged;

        pubs.AddDynEvent(Constants.UsrCntChange, UsrCntChange);

    }

    public void UsrCntChange(dynamic d)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        //pubs.UsrChanged -= UsrCntChange;
        pubs.RemoveDynEvent(Constants.UsrCntChange, UsrCntChange);

    }

}
